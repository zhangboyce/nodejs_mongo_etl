#!/usr/bin/env node
'use strict';

let cron = require('node-cron');
let arg_option = require('../lib/execute/ArgOption');
let Executor = require('../lib/execute/Executor');
let Constant = require('../lib/execute/Constant');

let argv = require('yargs')
    .option('t', arg_option.type)
    .option('d', arg_option.data)
    .option('h', arg_option.hours)
    .option('r', arg_option.range)
    .option('i', arg_option.import)
    .option('c', arg_option.cron)
    .usage('Usage: run [options]')
    .example('run -t feed -d project -h 48 -r 500 -i mongo',
        `exporting rss's projects before 48 hours and one time export 500 projects.`)
    .help('help')
    .argv;

let options = {
    type: argv.type,
    data: argv.data,
    hours: argv.hours,
    range: argv.range
};
let _import = argv.import;
let _cron = argv.cron;

let shell = require('shelljs/global');
echo(`run --options ${JSON.stringify(options)} --import ${_import} --cron ${_cron}`);

let executor = new Executor(options);
let run = ()=> {
    if (!_import) {
        executor.import2Mongo();
        executor.import2ES();
    }
    if (_import === Constant.IMPORT_MONGO) executor.import2Mongo();
    if (_import === Constant.IMPORT_ES) executor.import2ES();
};

if (_cron) {
    cron.schedule(_cron, ()=>{
        echo(`cron: ${_cron}`);
        run();
    });
} else {
    run();
}

